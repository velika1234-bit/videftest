<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VideoQuiz Ultimate</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üéì</text></svg>">
    
    <!-- –ë–ò–ë–õ–ò–û–¢–ï–ö–ò -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://www.youtube.com/iframe_api"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    
    <!-- –®—Ä–∏—Ñ—Ç–æ–≤–µ -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Nunito', 'sans-serif'] },
                    colors: {
                        brand: { 50: '#eef2ff', 100: '#e0e7ff', 500: '#6366f1', 600: '#4f46e5', 700: '#4338ca', 900: '#312e81' }
                    }
                }
            }
        }
    </script>

    <style>
        body { font-family: 'Nunito', sans-serif; -webkit-font-smoothing: antialiased; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }
        
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .glass { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
        .glass-dark { background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(10px); }

        #ind-overlay { z-index: 2147483647; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 h-screen overflow-hidden selection:bg-brand-100 selection:text-brand-700">

    <div id="app" class="h-full flex flex-col relative">
        
        <!-- LOADER -->
        <div id="auth-loader" class="fixed inset-0 bg-white z-[9999] flex items-center justify-center flex-col gap-6 transition-opacity duration-500">
            <div class="relative">
                <div class="w-20 h-20 border-4 border-slate-100 rounded-full"></div>
                <div class="w-20 h-20 border-4 border-brand-600 rounded-full animate-spin absolute top-0 left-0 border-t-transparent"></div>
                <div class="absolute top-0 left-0 w-20 h-20 flex items-center justify-center text-2xl">üéì</div>
            </div>
            <p class="font-black text-brand-900 text-lg tracking-widest animate-pulse">–ó–ê–†–ï–ñ–î–ê–ù–ï...</p>
        </div>

        <!-- NOTIFICATIONS -->
        <div id="msg-container" class="fixed top-6 right-6 z-[10000] flex flex-col items-end pointer-events-none gap-2"></div>

        <!-- 1. –ï–ö–†–ê–ù: –í–•–û–î -->
        <div id="screen-welcome" class="flex h-full w-full bg-slate-50 relative z-10 overflow-hidden flex-col md:flex-row">
            <!-- –õ—è–≤–æ: –£—á–µ–Ω–∏—Ü–∏ -->
            <div class="flex-1 relative flex flex-col justify-center items-center p-6 md:p-12 bg-white overflow-y-auto">
                <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-brand-500 via-purple-500 to-pink-500"></div>
                
                <div class="w-full max-w-lg space-y-8 animate-fade-in">
                    <div class="text-center space-y-2">
                        <div class="inline-flex items-center justify-center w-16 h-16 bg-brand-50 text-brand-600 rounded-2xl mb-4 shadow-sm">
                            <i data-lucide="graduation-cap" class="w-8 h-8"></i>
                        </div>
                        <h1 class="text-5xl font-black text-slate-900 tracking-tight">VideoQuiz</h1>
                        <p class="text-slate-500 font-bold text-lg">–£—á–∏ –∏ —Å–µ –∑–∞–±–∞–≤–ª—è–≤–∞–π!</p>
                    </div>

                    <div class="space-y-6">
                        <!-- –°–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª–Ω–æ -->
                        <div class="bg-white p-1 rounded-3xl border border-slate-200 shadow-xl shadow-slate-100/50 hover:shadow-2xl hover:border-brand-200 transition-all duration-300">
                            <div class="bg-slate-50 rounded-[1.2rem] p-6 border border-slate-100">
                                <div class="flex items-center gap-3 mb-4 text-brand-700">
                                    <div class="p-2 bg-white rounded-lg shadow-sm"><i data-lucide="play-circle" class="w-5 h-5"></i></div>
                                    <h3 class="font-black text-lg">–°–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª–Ω–æ</h3>
                                </div>
                                <form onsubmit="event.preventDefault(); window.startIndividual();" class="space-y-4">
                                     <input type="text" id="ind-quiz-code" placeholder="–í—ä–≤–µ–¥–∏ –∫–æ–¥ –Ω–∞ —É—Ä–æ–∫–∞..." class="w-full p-4 bg-white rounded-xl border border-slate-200 font-bold text-slate-700 placeholder:text-slate-400 focus:border-brand-500 focus:ring-4 focus:ring-brand-500/10 outline-none transition-all">
                                     
                                     <div class="flex flex-wrap gap-3">
                                        <label class="flex-1 flex items-center gap-2 cursor-pointer bg-white p-3 rounded-xl border border-slate-200 hover:border-brand-300 transition-all">
                                            <input type="checkbox" id="ind-sop-mode" class="w-5 h-5 accent-brand-600 rounded border-gray-300">
                                            <span class="text-xs font-bold text-slate-600 select-none">–°–û–ü (–ß–µ—Ç–µ—Ü)</span>
                                        </label>
                                        <label class="flex-1 flex items-center gap-2 cursor-pointer bg-white p-3 rounded-xl border border-slate-200 hover:border-amber-300 transition-all">
                                            <input type="checkbox" id="ind-discussion-mode" class="w-5 h-5 accent-amber-500 rounded border-gray-300">
                                            <span class="text-xs font-bold text-slate-600 select-none">–û–±—Å—ä–∂–¥–∞–Ω–µ</span>
                                        </label>
                                     </div>

                                     <button type="submit" class="w-full py-4 bg-brand-600 hover:bg-brand-700 text-white rounded-xl font-black uppercase text-sm tracking-wider shadow-lg shadow-brand-200 active:scale-[0.98] transition-all">–ó–∞–ø–æ—á–Ω–∏ –¢–µ—Å—Ç</button>
                                </form>
                            </div>
                        </div>

                        <!-- –í –∫–ª–∞—Å -->
                        <div class="relative group">
                            <div class="absolute -inset-0.5 bg-gradient-to-r from-emerald-400 to-teal-500 rounded-3xl opacity-20 group-hover:opacity-40 transition duration-500 blur"></div>
                            <div class="relative bg-white p-6 rounded-3xl border border-slate-100 shadow-xl">
                                <div class="flex items-center gap-3 mb-4 text-emerald-700">
                                    <div class="p-2 bg-emerald-50 rounded-lg"><i data-lucide="users" class="w-5 h-5"></i></div>
                                    <h3 class="font-black text-lg">–í –ö–ª–∞—Å (–ù–∞ –∂–∏–≤–æ)</h3>
                                </div>
                                <form onsubmit="event.preventDefault(); window.joinLiveSession();" class="space-y-3">
                                    <div class="grid grid-cols-2 gap-3">
                                        <input type="text" id="live-student-name" placeholder="–¢–≤–æ–µ—Ç–æ –ò–º–µ" class="w-full p-4 bg-slate-50 rounded-xl border-2 border-transparent focus:bg-white focus:border-emerald-500 font-bold text-center outline-none transition-all" autocomplete="off">
                                        <input type="number" id="live-pin" placeholder="–ü–ò–ù" class="w-full p-4 bg-slate-50 rounded-xl border-2 border-transparent focus:bg-white focus:border-emerald-500 font-black text-center text-xl tracking-widest outline-none transition-all" inputmode="numeric" autocomplete="off">
                                    </div>
                                    <button type="submit" class="w-full py-4 bg-emerald-500 hover:bg-emerald-600 text-white rounded-xl font-black uppercase text-sm tracking-wider shadow-lg shadow-emerald-200 active:scale-[0.98] transition-all">–í–ª–µ–∑ –≤ –°–µ—Å–∏—è</button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- –î—è—Å–Ω–æ: –£—á–∏—Ç–µ–ª–∏ -->
            <div class="w-full md:w-[400px] lg:w-[450px] bg-slate-900 text-white p-8 flex flex-col justify-center relative overflow-hidden shrink-0">
                <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] opacity-5"></div>
                <div class="absolute bottom-0 right-0 w-64 h-64 bg-brand-500/20 rounded-full blur-3xl -mr-16 -mb-16"></div>
                
                <div class="relative z-10 w-full max-w-sm mx-auto space-y-8 animate-fade-in">
                    <div>
                        <h2 id="auth-title" class="text-3xl font-black mb-1">–£—á–∏—Ç–µ–ª—Å–∫–∏ –≤—Ö–æ–¥</h2>
                        <p class="text-slate-400 text-sm">–£–ø—Ä–∞–≤–ª—è–≤–∞–π—Ç–µ –≤–∞—à–∏—Ç–µ –≤–∏–¥–µ–æ —É—Ä–æ—Ü–∏.</p>
                    </div>

                    <form onsubmit="event.preventDefault(); window.handleAuthSubmit();" class="space-y-4">
                        <div class="space-y-1">
                            <label class="text-[10px] font-bold text-slate-400 uppercase tracking-wider pl-1">–ò–º–µ–π–ª</label>
                            <div class="relative">
                                <i data-lucide="mail" class="absolute left-4 top-3.5 w-5 h-5 text-slate-500"></i>
                                <input type="email" id="auth-email" placeholder="name@school.bg" class="w-full pl-12 pr-4 py-3 bg-white/5 border border-white/10 rounded-xl text-white placeholder-slate-600 focus:bg-white/10 focus:border-brand-500 outline-none transition-all font-bold">
                            </div>
                        </div>
                        <div class="space-y-1">
                            <label class="text-[10px] font-bold text-slate-400 uppercase tracking-wider pl-1">–ü–∞—Ä–æ–ª–∞</label>
                            <div class="relative">
                                <i data-lucide="lock" class="absolute left-4 top-3.5 w-5 h-5 text-slate-500"></i>
                                <input type="password" id="auth-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" class="w-full pl-12 pr-4 py-3 bg-white/5 border border-white/10 rounded-xl text-white placeholder-slate-600 focus:bg-white/10 focus:border-brand-500 outline-none transition-all font-bold">
                            </div>
                        </div>
                        
                        <div id="auth-teacher-code-container" class="hidden space-y-1 animate-pop">
                             <label class="text-[10px] font-bold text-amber-500 uppercase tracking-wider pl-1">–ö–æ–¥ –∑–∞ –¥–æ—Å—Ç—ä–ø</label>
                             <input type="password" id="auth-teacher-code" placeholder="–í—ä–≤–µ–¥–µ—Ç–µ –∫–æ–¥..." class="w-full p-3 bg-amber-500/10 border border-amber-500/30 rounded-xl text-amber-200 placeholder-amber-500/50 outline-none font-bold text-center tracking-widest">
                        </div>

                        <button type="submit" id="auth-submit-btn" class="w-full py-4 bg-brand-600 hover:bg-brand-500 text-white rounded-xl font-black uppercase tracking-wider shadow-lg shadow-brand-900/50 active:scale-[0.98] transition-all">–í–ª–µ–∑</button>
                    </form>

                    <div class="text-center pt-4 border-t border-white/5">
                        <button id="auth-toggle-text" onclick="window.toggleAuthMode()" class="text-sm text-slate-400 hover:text-white font-bold transition-colors">–ù—è–º–∞—Ç–µ –∞–∫–∞—É–Ω—Ç? <span class="text-brand-400">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</span></button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 2. –ï–ö–†–ê–ù: –£–ß–ò–¢–ï–õ–°–ö–ò –ü–ê–ù–ï–õ -->
        <div id="screen-teacher-dashboard" class="hidden h-full flex flex-col bg-slate-50 absolute inset-0 z-20">
             <header class="bg-white border-b border-slate-200 px-6 py-3 flex justify-between items-center sticky top-0 z-20 shadow-sm">
                 <div class="flex items-center gap-3">
                     <div class="w-10 h-10 bg-brand-600 rounded-xl flex items-center justify-center text-white shadow-lg shadow-brand-200"><i data-lucide="library" class="w-5 h-5"></i></div>
                     <div><h1 class="font-black text-slate-800 text-lg leading-tight">–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞</h1><p id="user-email-display" class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">...</p></div>
                 </div>
                 <div class="flex items-center gap-2">
                     <!-- –ü—Ä–µ–º–∞—Ö–Ω–∞—Ç –±—É—Ç–æ–Ω Admin -->
                     <div class="h-8 w-px bg-slate-200 mx-2"></div>
                     <button onclick="window.openImportModal()" class="p-2 text-slate-500 hover:text-emerald-600 hover:bg-emerald-50 rounded-lg transition-all" title="–ò–º–ø–æ—Ä—Ç"><i data-lucide="download" class="w-5 h-5"></i></button>
                     <button onclick="window.switchScreen('create'); window.loadEditorVideo(false);" class="px-5 py-2.5 bg-brand-600 text-white rounded-xl font-bold text-xs hover:bg-brand-700 transition-all shadow-md shadow-brand-200 flex items-center gap-2"><i data-lucide="plus" class="w-4 h-4"></i> –ù–æ–≤ –£—Ä–æ–∫</button>
                     <button onclick="window.handleLogout()" class="p-2 text-slate-400 hover:text-rose-500 transition-colors ml-2" title="–ò–∑—Ö–æ–¥"><i data-lucide="log-out" class="w-5 h-5"></i></button>
                 </div>
             </header>

             <main class="flex-1 overflow-y-auto p-6 max-w-7xl mx-auto w-full space-y-8">
                 <section class="grid grid-cols-1 md:grid-cols-3 gap-4">
                     <div class="bg-white p-5 rounded-2xl border border-slate-100 shadow-sm flex items-center gap-4">
                         <div class="w-12 h-12 bg-blue-50 text-blue-600 rounded-full flex items-center justify-center"><i data-lucide="book" class="w-6 h-6"></i></div>
                         <div><p class="text-xs text-slate-400 font-bold uppercase">–û–±—â–æ –£—Ä–æ—Ü–∏</p><h3 class="text-2xl font-black text-slate-800" id="stat-total-quizzes">0</h3></div>
                     </div>
                 </section>

                 <section>
                     <div class="flex justify-between items-end mb-4">
                        <h2 class="text-xl font-black text-slate-800">–í–∞—à–∏—Ç–µ –£—Ä–æ—Ü–∏</h2>
                     </div>
                     <div id="my-quizzes-list" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6"></div>
                 </section>

                 <section class="bg-white rounded-3xl border border-slate-200 shadow-sm overflow-hidden">
                     <div class="p-6 border-b border-slate-100 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 bg-slate-50/50">
                         <div>
                             <h2 class="font-black text-slate-800 text-lg">–ò—Å—Ç–æ—Ä–∏—è –Ω–∞ —Ä–µ–∑—É–ª—Ç–∞—Ç–∏—Ç–µ</h2>
                             <p id="solo-results-summary" class="text-xs text-slate-400 font-bold mt-1">–ó–∞—Ä–µ–∂–¥–∞–Ω–µ...</p>
                         </div>
                         <button onclick="window.exportSoloResultsExcel()" class="px-4 py-2 bg-white border border-slate-200 text-slate-600 rounded-lg font-bold text-xs hover:bg-slate-50 hover:text-brand-600 transition-all flex items-center gap-2"><i data-lucide="file-spreadsheet" class="w-4 h-4"></i> –ï–∫—Å–ø–æ—Ä—Ç Excel</button>
                     </div>
                     <div class="overflow-x-auto">
                         <table class="w-full text-left text-sm">
                             <thead class="bg-slate-50 text-slate-500 font-bold text-xs uppercase tracking-wider border-b border-slate-100">
                                 <tr><th class="p-4 pl-6">–£—á–µ–Ω–∏–∫</th><th class="p-4">–£—Ä–æ–∫</th><th class="p-4">–î–∞—Ç–∞</th><th class="p-4 text-right">–†–µ–∑—É–ª—Ç–∞—Ç</th><th class="p-4 text-center">–î–µ–π—Å—Ç–≤–∏–µ</th></tr>
                             </thead>
                             <tbody id="solo-results-body" class="divide-y divide-slate-50"></tbody>
                         </table>
                     </div>
                 </section>
             </main>
        </div>

        <!-- 3. –ï–ö–†–ê–ù: –†–ï–î–ê–ö–¢–û–† -->
        <div id="screen-create" class="hidden h-full flex flex-col bg-slate-100 absolute inset-0 z-30">
            <header class="bg-white border-b px-6 py-3 flex justify-between items-center sticky top-0 z-30 shadow-sm">
                <div class="flex items-center gap-4">
                    <button onclick="window.switchScreen('teacher-dashboard')" class="p-2 text-slate-400 hover:text-slate-700 hover:bg-slate-100 rounded-lg transition-all"><i data-lucide="arrow-left" class="w-5 h-5"></i></button>
                    <h2 class="font-black text-slate-800 text-lg">–†–µ–¥–∞–∫—Ç–æ—Ä –Ω–∞ —É—Ä–æ–∫</h2>
                </div>
                <button onclick="window.saveQuizToLibrary()" class="px-6 py-2.5 bg-brand-600 text-white rounded-xl font-bold text-sm shadow-md hover:bg-brand-700 transition-all flex items-center gap-2"><i data-lucide="save" class="w-4 h-4"></i> –ó–∞–ø–∞–∑–∏</button>
            </header>
            
            <div class="flex-1 flex flex-col lg:flex-row overflow-hidden">
                <!-- –õ–Ø–í–û: –í–∏–¥–µ–æ -->
                <div class="flex-1 bg-black relative flex flex-col justify-center group">
                    <div id="editor-player-container" class="aspect-video w-full max-h-full mx-auto"></div>
                    
                    <!-- Empty State / URL Input -->
                    <div id="editor-view" class="absolute inset-0 bg-slate-900/95 z-20 flex flex-col items-center justify-center p-8 hidden"></div>
                    
                    <!-- URL Bar Overlay -->
                    <div class="absolute top-6 left-6 right-6 z-30 flex gap-2 transition-opacity duration-300 opacity-100 group-hover:opacity-100">
                        <div class="flex-1 relative">
                            <i data-lucide="link" class="absolute left-4 top-3.5 w-4 h-4 text-slate-400"></i>
                            <input type="text" id="yt-url" placeholder="–ü–æ—Å—Ç–∞–≤–∏ YouTube –ª–∏–Ω–∫ —Ç—É–∫..." class="w-full pl-10 pr-4 py-3 rounded-xl border-none shadow-xl bg-white/95 backdrop-blur font-bold text-sm outline-none focus:ring-2 focus:ring-brand-500 text-slate-800">
                        </div>
                        <button onclick="window.loadEditorVideo()" class="px-6 py-3 bg-brand-600 text-white rounded-xl font-bold text-sm shadow-xl hover:bg-brand-700 transition-all">–ó–∞—Ä–µ–¥–∏</button>
                    </div>
                </div>

                <!-- –î–Ø–°–ù–û: –í—ä–ø—Ä–æ—Å–∏ -->
                <div class="w-full lg:w-96 bg-white border-l border-slate-200 flex flex-col z-20 shadow-xl">
                    <div class="p-5 border-b bg-slate-50 flex justify-between items-center">
                        <span class="text-xs font-black text-slate-400 uppercase tracking-widest">–¢–≤–æ–∏—Ç–µ –í—ä–ø—Ä–æ—Å–∏</span>
                        <div class="flex items-center gap-3">
                            <div class="bg-brand-100 text-brand-700 px-3 py-1 rounded-lg font-mono font-bold text-xs" id="timer">00:00</div>
                            <button onclick="window.openQuestionModal()" class="w-8 h-8 bg-brand-600 text-white rounded-full flex items-center justify-center hover:scale-110 hover:shadow-lg transition-all"><i data-lucide="plus" class="w-5 h-5"></i></button>
                        </div>
                    </div>
                    <div id="q-list" class="flex-1 overflow-y-auto p-4 space-y-3 bg-slate-50/50"></div>
                </div>
            </div>
        </div>

        <!-- 4. –ï–ö–†–ê–ù: –ù–ê –ñ–ò–í–û (HOST) -->
        <div id="screen-live-host" class="hidden h-full flex flex-col bg-slate-900 absolute inset-0 z-40">
            <div class="bg-slate-800 text-white px-6 py-3 shadow-lg flex justify-between items-center shrink-0 z-20 border-b border-slate-700">
                <div class="flex items-center gap-4">
                    <div class="bg-brand-600 px-5 py-2 rounded-xl shadow-lg shadow-brand-900/50">
                        <span class="text-[10px] uppercase font-bold text-brand-200 tracking-widest block leading-none mb-1">–ö–û–î –ó–ê –í–•–û–î</span>
                        <h1 id="host-pin" class="text-4xl font-black leading-none tracking-widest text-white">...</h1>
                    </div>
                    <div class="h-8 w-px bg-slate-700"></div>
                    <div class="text-slate-300 text-sm font-bold flex items-center gap-2">
                        <i data-lucide="users" class="w-4 h-4"></i> <span id="host-participant-count">0</span> —É—á–∞—Å—Ç–Ω–∏—Ü–∏
                    </div>
                    <!-- –î–æ–±–∞–≤–µ–Ω —Ç–∞–π–º–µ—Ä -->
                    <span id="host-timer" class="font-mono text-xl font-bold bg-slate-700 px-3 py-1 rounded-lg">00:00</span>
                </div>

                <div class="flex gap-2">
                    <div id="export-buttons-container" class="hidden gap-2 animate-fade-in">
                        <button onclick="window.exportExcel()" class="px-4 py-2 bg-emerald-600 hover:bg-emerald-500 text-white rounded-lg font-bold text-xs flex items-center gap-2 transition-all"><i data-lucide="file-spreadsheet" class="w-4 h-4"></i> Excel</button>
                        <button onclick="window.exportPDF()" class="px-4 py-2 bg-rose-600 hover:bg-rose-500 text-white rounded-lg font-bold text-xs flex items-center gap-2 transition-all"><i data-lucide="file-text" class="w-4 h-4"></i> PDF</button>
                    </div>
                    <button onclick="window.quitHostSession()" class="px-4 py-2 bg-slate-700 hover:bg-slate-600 text-slate-200 rounded-lg font-bold text-xs transition-all border border-slate-600">–ö–†–ê–ô</button>
                </div>
            </div>

            <div class="flex-1 flex flex-col lg:flex-row overflow-hidden">
                <!-- –õ–Ø–í–û: –í–∏–¥–µ–æ -->
                <div class="flex-1 bg-black relative flex flex-col justify-center">
                    <div id="host-video-container" class="w-full h-full"></div>
                    
                    <div id="host-stats-bar" class="hidden absolute top-4 left-4 right-4 bg-black/60 backdrop-blur-md px-6 py-3 rounded-2xl border border-white/10 flex items-center gap-4 transition-all z-10">
                         <div id="class-progress-bar" class="flex-1 h-3 bg-white/10 rounded-full overflow-hidden flex">
                            <div id="progress-correct" class="bg-emerald-500 h-full transition-all duration-500" style="width: 0%"></div>
                            <div id="progress-wrong" class="bg-rose-500 h-full transition-all duration-500" style="width: 0%"></div>
                         </div>
                         <span id="progress-percent" class="font-black text-white text-lg font-mono">0%</span>
                    </div>

                    <div id="host-setup-area" class="absolute inset-0 flex flex-col items-center justify-center bg-black/80 z-20 backdrop-blur-sm gap-6">
                         <h2 class="text-3xl font-black text-white tracking-tight">–ì–æ—Ç–æ–≤–∏ –ª–∏ —Å—Ç–µ?</h2>
                         <button onclick="window.initHostPlayer()" class="px-10 py-5 bg-brand-600 text-white rounded-2xl font-black text-2xl hover:bg-brand-500 transition-all shadow-[0_0_40px_rgba(79,70,229,0.5)] hover:scale-105 active:scale-95 flex items-center gap-3">
                             <i data-lucide="play" class="w-8 h-8 fill-current"></i> –°–¢–ê–†–¢
                         </button>
                         <p class="text-slate-400 font-bold">–ò–∑—á–∞–∫–∞–π—Ç–µ –≤—Å–∏—á–∫–∏ –¥–∞ —Å–µ –ø—Ä–∏—Å—ä–µ–¥–∏–Ω—è—Ç.</p>
                    </div>
                </div>

                <!-- –î–Ø–°–ù–û: –ö–ª–∞—Å–∏—Ä–∞–Ω–µ -->
                <div class="w-full lg:w-80 flex flex-col shrink-0 bg-white border-l border-slate-200 z-30 shadow-2xl">
                    <div class="p-4 border-b border-slate-100 bg-slate-50">
                        <h3 class="font-black text-slate-800 uppercase tracking-widest text-xs flex items-center gap-2"><i data-lucide="trophy" class="w-4 h-4 text-amber-500"></i> –ö–ª–∞—Å–∏—Ä–∞–Ω–µ</h3>
                    </div>
                    
                    <div class="flex-1 overflow-y-auto p-2 scrollbar-hide relative bg-slate-50">
                        <table class="w-full text-left border-separate border-spacing-y-2">
                            <tbody id="host-results-body"></tbody>
                        </table>
                    </div>

                    <!-- QR Code Footer -->
                    <div id="host-qr-container" class="p-6 border-t border-slate-200 bg-white flex flex-col items-center justify-center shrink-0"></div>
                </div>
            </div>
        </div>

        <!-- 5. –ï–ö–†–ê–ù: –£–ß–ï–ù–ò–ö -->
        <div id="screen-live-client" class="hidden h-full flex flex-col bg-slate-50 absolute inset-0 z-50 overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-2 bg-brand-500 z-20"></div>
            
            <div id="client-waiting" class="flex-1 flex flex-col items-center justify-center p-8 text-center space-y-8 animate-fade-in">
                <div class="w-32 h-32 bg-white rounded-full flex items-center justify-center text-6xl shadow-xl animate-bounce border-4 border-slate-100">üëÄ</div>
                <div>
                    <h2 class="text-3xl font-black text-slate-800 mb-2">–ì–ª–µ–¥–∞–π –µ–∫—Ä–∞–Ω–∞!</h2>
                    <p id="waiting-status-text" class="text-slate-500 font-bold text-lg">–û—á–∞–∫–≤–∞–π –≤—ä–ø—Ä–æ—Å...</p>
                </div>
                <div class="bg-white px-8 py-4 rounded-2xl shadow-sm border border-slate-200 flex items-center gap-4">
                    <span id="my-avatar-display" class="text-3xl">üòé</span>
                    <div class="text-left">
                        <p class="text-xs font-bold text-slate-400 uppercase">–ò–≥—Ä–∞—á</p>
                        <p class="font-black text-slate-800 text-lg leading-none" id="client-player-name">...</p>
                    </div>
                </div>
            </div>

            <div id="client-question" class="hidden flex-1 flex flex-col p-6 pb-32 overflow-y-auto animate-fade-in">
                <div class="bg-white p-8 rounded-3xl shadow-lg border-b-8 border-slate-100 mb-6 text-center">
                    <p id="live-q-text-client" class="text-xl md:text-2xl font-black text-slate-800 leading-snug">...</p>
                </div>
                <div id="live-options-client" class="space-y-3 max-w-md mx-auto w-full"></div>
            </div>

            <div id="client-finished" class="hidden flex-1 flex flex-col items-center justify-center p-8 bg-brand-600 text-white text-center absolute inset-0 z-50">
                <h1 class="text-5xl font-black mb-2 animate-pop">–ö–†–ê–ô!</h1>
                <p class="font-bold opacity-80 mb-10 text-xl">–¢–≤–æ—è—Ç —Ä–µ–∑—É–ª—Ç–∞—Ç:</p>
                <div class="bg-white text-brand-600 w-48 h-48 rounded-full flex items-center justify-center font-black text-6xl shadow-2xl mb-12 border-8 border-brand-400" id="final-score-display">0</div>
                <button onclick="location.reload()" class="px-10 py-4 bg-brand-800 hover:bg-brand-900 rounded-2xl font-bold text-lg transition-all shadow-lg">–ù–æ–≤–∞ –∏–≥—Ä–∞</button>
            </div>
        </div>

        <!-- 6. –ï–ö–†–ê–ù: –ò–ù–î–ò–í–ò–î–£–ê–õ–ù–û -->
        <div id="screen-solve" class="hidden h-full flex flex-col bg-black absolute inset-0 z-50">
            <div class="flex-1 relative flex items-center justify-center">
                <div id="solve-player-container" class="w-full h-full absolute inset-0"></div>
                <div id="ind-overlay" class="absolute inset-0 bg-slate-900/95 z-[9999] hidden flex-col items-center justify-center p-6 sm:p-10 animate-fade-in overflow-y-auto">
                    <div class="w-full max-w-2xl space-y-10 text-center">
                         <h2 id="ind-overlay-q-text" class="font-black text-white leading-tight drop-shadow-lg text-3xl">–í—ä–ø—Ä–æ—Å?</h2>
                         <div id="ind-overlay-options" class="grid gap-4 w-full"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 7. –ï–ö–†–ê–ù: –§–ò–ù–ê–õ -->
        <div id="screen-finish" class="hidden h-full flex flex-col items-center justify-center bg-slate-50 p-8 text-center absolute inset-0 z-50">
            <div class="bg-white p-12 rounded-[3rem] shadow-2xl border-b-8 border-indigo-100 max-w-md w-full space-y-8 animate-pop">
                <div class="w-24 h-24 bg-indigo-100 text-indigo-600 rounded-full flex items-center justify-center mx-auto text-5xl mb-2">üèÜ</div>
                <div>
                    <h2 class="text-3xl font-black text-slate-800 mb-2">–†–µ–∑—É–ª—Ç–∞—Ç</h2>
                    <div id="res-score" class="text-6xl font-black text-indigo-600 py-2">0 / 0</div>
                </div>
                <button onclick="window.quitToWelcome()" class="w-full py-4 bg-slate-800 text-white rounded-2xl font-bold uppercase tracking-wider hover:bg-slate-900 transition-all shadow-lg">–ù–∞—á–∞–ª–æ</button>
            </div>
        </div>

        <!-- –ú–û–î–ê–õ: –í–™–ü–†–û–° -->
        <div id="modal-q" class="hidden fixed inset-0 bg-black/60 z-[100] items-center justify-center p-4 backdrop-blur-md">
            <div class="bg-white rounded-3xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col overflow-hidden animate-pop border border-slate-200">
                <div class="p-6 border-b bg-slate-50 flex justify-between items-center">
                    <h3 id="m-title-text" class="font-black text-xl text-slate-800">–í—ä–ø—Ä–æ—Å</h3>
                    <button onclick="document.getElementById('modal-q').classList.add('hidden')" class="w-8 h-8 flex items-center justify-center rounded-full bg-slate-200 text-slate-500 hover:bg-rose-100 hover:text-rose-500 transition-all"><i data-lucide="x" class="w-5 h-5"></i></button>
                </div>
                <div class="p-8 overflow-y-auto space-y-6">
                     <div>
                         <label class="block text-xs font-bold text-slate-400 uppercase mb-2 tracking-wider">–¢–µ–∫—Å—Ç –Ω–∞ –≤—ä–ø—Ä–æ—Å–∞</label>
                         <textarea id="m-text" class="w-full p-4 bg-slate-50 border-2 border-slate-200 rounded-2xl font-bold text-slate-800 outline-none focus:border-brand-500 focus:bg-white transition-all h-28 resize-none text-lg"></textarea>
                     </div>
                     <div class="grid grid-cols-2 gap-6">
                         <div>
                             <label class="block text-xs font-bold text-slate-400 uppercase mb-2 tracking-wider">–¢–∏–ø –æ—Ç–≥–æ–≤–æ—Ä</label>
                             <div class="relative">
                                 <select id="m-type" onchange="window.updateModalFields()" class="w-full p-4 bg-slate-50 border-2 border-slate-200 rounded-xl font-bold text-sm outline-none appearance-none focus:border-brand-500">
                                     <option value="single">–ï–¥–∏–Ω –≤–µ—Ä–µ–Ω</option>
                                     <option value="multiple">–ú–Ω–æ–∂–µ—Å—Ç–≤–æ –≤–µ—Ä–Ω–∏</option>
                                     <option value="boolean">–í—è—Ä–Ω–æ / –ì—Ä–µ—à–Ω–æ</option>
                                     <option value="open">–û—Ç–≤–æ—Ä–µ–Ω –æ—Ç–≥–æ–≤–æ—Ä</option>
                                 </select>
                                 <i data-lucide="chevron-down" class="absolute right-4 top-4 w-5 h-5 text-slate-400 pointer-events-none"></i>
                             </div>
                         </div>
                         <div>
                             <label class="block text-xs font-bold text-slate-400 uppercase mb-2 tracking-wider">–¢–æ—á–∫–∏</label>
                             <input type="number" id="m-points" value="1" min="1" class="w-full p-4 bg-slate-50 border-2 border-slate-200 rounded-xl font-bold text-sm outline-none focus:border-brand-500">
                         </div>
                     </div>
                     <div id="m-opts-container" class="pt-2 border-t border-slate-100"></div>
                </div>
                <div class="p-6 border-t bg-slate-50">
                    <button onclick="window.saveQuestion()" class="w-full py-4 bg-brand-600 text-white rounded-2xl font-black uppercase tracking-wider hover:bg-brand-700 shadow-lg shadow-brand-200 transition-all">–ó–∞–ø–∞–∑–∏ –ü—Ä–æ–º–µ–Ω–∏—Ç–µ</button>
                </div>
            </div>
        </div>

        <!-- –ú–û–î–ê–õ: –°–ü–û–î–ï–õ–Ø–ù–ï -->
        <div id="modal-share" class="hidden fixed inset-0 bg-black/60 z-[100] items-center justify-center p-4 backdrop-blur-sm">
            <div class="bg-white rounded-3xl p-10 max-w-md w-full text-center space-y-8 animate-pop shadow-2xl">
                <div class="w-20 h-20 bg-amber-100 text-amber-600 rounded-full flex items-center justify-center mx-auto mb-2"><i data-lucide="share-2" class="w-10 h-10"></i></div>
                <div>
                    <h3 class="text-2xl font-black text-slate-800">–°–ø–æ–¥–µ–ª–∏ –£—Ä–æ–∫–∞</h3>
                    <p class="text-slate-500 font-bold mt-2">–ö–æ–¥ –∑–∞ —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª–Ω–∞ —Ä–∞–±–æ—Ç–∞:</p>
                </div>
                <div class="relative group">
                    <input type="text" id="share-code-display" readonly class="w-full p-5 bg-slate-50 border-2 border-slate-200 rounded-2xl font-mono text-sm text-slate-600 break-all pr-14 outline-none group-hover:border-brand-300 transition-colors">
                    <button onclick="window.copyShareCode()" class="absolute right-3 top-3 p-2 bg-white border border-slate-200 rounded-xl hover:bg-brand-50 hover:text-brand-600 hover:border-brand-200 transition-all"><i data-lucide="copy" class="w-5 h-5"></i></button>
                </div>
                <button onclick="document.getElementById('modal-share').classList.add('hidden')" class="text-sm font-bold text-slate-400 hover:text-slate-800 transition-colors">–ó–∞—Ç–≤–æ—Ä–∏</button>
            </div>
        </div>
        
        <!-- –ú–û–î–ê–õ: –ò–ú–ü–û–†–¢ -->
        <div id="modal-import" class="hidden fixed inset-0 bg-black/60 z-[100] items-center justify-center p-4 backdrop-blur-sm">
             <div class="bg-white rounded-3xl p-8 max-w-lg w-full space-y-6 animate-pop shadow-2xl">
                 <div class="flex justify-between items-center">
                     <h3 class="text-2xl font-black text-slate-800">–ò–º–ø–æ—Ä—Ç –Ω–∞ –£—Ä–æ–∫</h3>
                     <button onclick="document.getElementById('modal-import').classList.add('hidden')" class="text-slate-400 hover:text-slate-600"><i data-lucide="x" class="w-6 h-6"></i></button>
                 </div>
                 <textarea id="import-code-input" placeholder="–ü–æ—Å—Ç–∞–≤–µ—Ç–µ –∫–æ–¥–∞ —Ç—É–∫..." class="w-full p-4 bg-slate-50 border-2 border-slate-200 rounded-2xl font-mono text-xs h-40 resize-none outline-none focus:border-brand-500 transition-all"></textarea>
                 <button onclick="window.submitImport()" class="w-full py-4 bg-emerald-500 text-white rounded-xl font-bold text-sm hover:bg-emerald-600 shadow-lg shadow-emerald-100 transition-all">–ò–ú–ü–û–†–¢–ò–†–ê–ô</button>
             </div>
        </div>
        
        <!-- –ú–û–î–ê–õ: –ü–†–ê–í–ê (–∑–∞–ø–∞–∑–µ–Ω) -->
        <div id="modal-rules-help" class="hidden fixed inset-0 bg-black/80 z-[10000] items-center justify-center p-4 backdrop-blur-md">
            <div class="bg-white rounded-3xl p-10 max-w-lg w-full space-y-6 animate-pop shadow-2xl relative">
                <div class="text-center space-y-4">
                    <div class="w-20 h-20 bg-rose-100 text-rose-600 rounded-full flex items-center justify-center mx-auto"><i data-lucide="shield-alert" class="w-10 h-10"></i></div>
                    <h3 class="text-2xl font-black text-slate-900">–ë—Ä–∞—É–∑—ä—Ä—ä—Ç –±–ª–æ–∫–∏—Ä–∞ –±–∞–∑–∞—Ç–∞ –¥–∞–Ω–Ω–∏</h3>
                </div>
                <div class="text-sm text-slate-600 space-y-3 leading-relaxed bg-slate-50 p-6 rounded-2xl border border-slate-200 text-left">
                    <p class="font-bold">–ö–∞–∫ –¥–∞ –æ–ø—Ä–∞–≤–∏—Ç–µ —Ç–æ–≤–∞?</p>
                    <p>1. –ê–∫–æ —Å—Ç–µ –≤ <strong>Chrome/Edge</strong>: –ö–ª–∏–∫–Ω–µ—Ç–µ –Ω–∞ –∏–∫–æ–Ω–∞—Ç–∞ "–æ–∫–æ" –∏–ª–∏ "–∫–∞—Ç–∏–Ω–∞—Ä" –≤ –∞–¥—Ä–µ—Å–Ω–∞—Ç–∞ –ª–µ–Ω—Ç–∞ –∏ —Ä–∞–∑—Ä–µ—à–µ—Ç–µ –±–∏—Å–∫–≤–∏—Ç–∫–∏—Ç–µ (Third-party cookies).</p>
                    <p>2. –ê–∫–æ —Å—Ç–µ –≤ <strong>Incognito</strong> —Ä–µ–∂–∏–º: –û—Ç–≤–æ—Ä–µ—Ç–µ –≤ –Ω–æ—Ä–º–∞–ª–µ–Ω –ø—Ä–æ–∑–æ—Ä–µ—Ü.</p>
                </div>
                <button onclick="window.requestStorageAccess()" class="w-full py-4 bg-brand-600 text-white rounded-xl font-black uppercase text-sm hover:bg-brand-700 transition-all shadow-lg">–û–ø–∏—Ç–∞–π –ø–∞–∫</button>
            </div>
        </div>

        <!-- –ú–û–î–ê–õ: –ó–ê–ü–ê–ó–í–ê–ù–ï –ù–ê –£–†–û–ö -->
        <div id="modal-save-quiz" class="hidden fixed inset-0 bg-black/60 z-[100] items-center justify-center p-4 backdrop-blur-sm">
            <div class="bg-white rounded-3xl p-8 max-w-md w-full space-y-6 animate-pop shadow-2xl">
                <div class="flex justify-between items-center">
                    <h3 class="text-2xl font-black text-slate-800">–ó–∞–ø–∞–∑–∏ —É—Ä–æ–∫–∞</h3>
                    <button onclick="document.getElementById('modal-save-quiz').classList.add('hidden')" class="text-slate-400 hover:text-slate-600"><i data-lucide="x" class="w-6 h-6"></i></button>
                </div>
                <input type="text" id="save-quiz-title" placeholder="–ó–∞–≥–ª–∞–≤–∏–µ –Ω–∞ —É—Ä–æ–∫–∞" class="w-full p-4 bg-slate-50 border-2 border-slate-200 rounded-xl font-bold text-sm outline-none focus:border-brand-500">
                <button onclick="window.performSaveQuiz()" class="w-full py-4 bg-brand-600 text-white rounded-xl font-bold text-sm hover:bg-brand-700 transition-all">–ó–ê–ü–ê–ó–ò</button>
            </div>
        </div>
    </div>

    <!-- –õ–û–ì–ò–ö–ê (–ø—Ä–µ—Ä–∞–±–æ—Ç–µ–Ω–∞) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, getDoc, onSnapshot, serverTimestamp, updateDoc, deleteDoc, addDoc, query, where, limit, getDocs, collectionGroup } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signOut, createUserWithEmailAndPassword, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFunctions } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-functions.js";

        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
        const firebaseConfig = { apiKey: "AIzaSyA0WhbnxygznaGCcdxLBHweZZThezUO314", authDomain: "videoquiz-ultimate.firebaseapp.com", projectId: "videoquiz-ultimate", storageBucket: "videoquiz-ultimate.firebasestorage.app", messagingSenderId: "793138692820", appId: "1:793138692820:web:8ee2418d28d47fca6bf141" };
        const finalAppId = 'videoquiz-ultimate-live';
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const functions = getFunctions(app, 'us-central1');

        // ========== –ì–õ–û–ë–ê–õ–ù–ò –ü–†–û–ú–ï–ù–õ–ò–í–ò ==========
        let user = null;
        let isTeacher = false;
        let currentQuiz = null;          // –¢–µ–∫—É—â–æ –∑–∞—Ä–µ–¥–µ–Ω —É—Ä–æ–∫ (–æ–±–µ–∫—Ç)
        let player = null;                // YouTube –ø–ª–µ–π—ä—Ä –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞
        let solvePlayer = null;            // YouTube –ø–ª–µ–π—ä—Ä –∑–∞ —Å–æ–ª–æ
        let hostPlayer = null;             // YouTube –ø–ª–µ–π—ä—Ä –∑–∞ —Ö–æ—Å—Ç
        let questions = [];                // –í—ä–ø—Ä–æ—Å–∏ –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞
        let sessionID = "";                // –¢–µ–∫—É—â –ü–ò–ù –Ω–∞ —Å–µ—Å–∏—è
        let liveActiveQIdx = -1;            // –ò–Ω–¥–µ–∫—Å –Ω–∞ –∞–∫—Ç–∏–≤–Ω–∏—è –≤—ä–ø—Ä–æ—Å –≤ —Å–µ—Å–∏—è
        let sessionDocId = "";              // ID –Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞ –Ω–∞ —Å–µ—Å–∏—è—Ç–∞ (—Å—ä—â–æ—Ç–æ –∫–∞—Ç–æ –ü–ò–ù)
        let liveScore = 0;                  // –¢–æ—á–∫–∏ –Ω–∞ —É—á–µ–Ω–∏–∫–∞ –≤ live —Å–µ—Å–∏—è
        let unsubscribes = [];               // –ú–∞—Å–∏–≤ –∑–∞ –≤—Å–∏—á–∫–∏ Firebase listeners
        let activeIntervals = [];            // –ú–∞—Å–∏–≤ –∑–∞ –≤—Å–∏—á–∫–∏ –∞–∫—Ç–∏–≤–Ω–∏ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∏
        let lastFetchedParticipants = [];     // –ö–µ—à –Ω–∞ —É—á–∞—Å—Ç–Ω–∏—Ü–∏—Ç–µ –∑–∞ —Ö–æ—Å—Ç–∞
        let soloResults = [];                 // –ö–µ—à –Ω–∞ —Ä–µ–∑—É–ª—Ç–∞—Ç–∏—Ç–µ –∑–∞ —É—á–∏—Ç–µ–ª—è
        let myQuizzes = [];                   // –ö–µ—à –Ω–∞ —É—Ä–æ—Ü–∏—Ç–µ –Ω–∞ —É—á–∏—Ç–µ–ª—è
        let authMode = 'login';                // –†–µ–∂–∏–º –Ω–∞ –≤—Ö–æ–¥ (login/register)
        let soloGameFinished = false;          // –î–∞–ª–∏ —Å–æ–ª–æ –∏–≥—Ä–∞—Ç–∞ –µ –ø—Ä–∏–∫–ª—é—á–∏–ª–∞
        let sopModeEnabled = false;            // –°–û–ü —Ä–µ–∂–∏–º (—á–µ—Ç–µ—Ü)
        let isDiscussionMode = false;          // –†–µ–∂–∏–º –Ω–∞ –æ–±—Å—ä–∂–¥–∞–Ω–µ (–±–µ–∑ –∑–∞–ø–∏—Å)
        let studentNameValue = "";              // –ò–º–µ –Ω–∞ —É—á–µ–Ω–∏–∫
        let currentQuizOwnerId = null;          // ID –Ω–∞ —É—á–∏—Ç–µ–ª—è, —Å—ä–∑–¥–∞–ª —É—Ä–æ–∫–∞ (–∑–∞ –∑–∞–ø–∏—Å –Ω–∞ —Ä–µ–∑—É–ª—Ç–∞—Ç–∏)
        let editingQuizId = null;               // ID –Ω–∞ —É—Ä–æ–∫–∞, –∫–æ–π—Ç–æ —Å–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–∞ (–∞–∫–æ –∏–º–∞)
        let currentVideoId = null;               // –¢–µ–∫—É—â YouTube ID –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞
        let lastAnsweredIdx = -1;                // –ò–Ω–¥–µ–∫—Å –Ω–∞ –ø–æ—Å–ª–µ–¥–Ω–∏—è –æ—Ç–≥–æ–≤–æ—Ä–µ–Ω –≤—ä–ø—Ä–æ—Å –≤ —Å–æ–ª–æ
        let currentQIndex = 0;                   // –¢–µ–∫—É—â –≤—ä–ø—Ä–æ—Å –≤ —Å–æ–ª–æ (–∏–Ω–¥–µ–∫—Å)
        let scoreCount = 0;                       // –¢–æ—á–∫–∏ –≤ —Å–æ–ª–æ
        let liveCurrentQ = null;                   // –¢–µ–∫—É—â –≤—ä–ø—Ä–æ—Å –≤ live —Å–µ—Å–∏—è (–∑–∞ —É—á–µ–Ω–∏–∫–∞)

        // –ü–æ–º–æ—â–Ω–∏ —Ñ—É–Ω–∫—Ü–∏–∏
        const AVATARS = ['üê∂','üê±','üê≠','üêπ','üê∞','ü¶ä','üêª','üêº','üê®','üêØ','ü¶Å','üêÆ','üê∑','üê∏','üêµ'];
        function formatTime(s) { const m = Math.floor(s / 60), sc = Math.floor(s % 60); return `${m}:${sc < 10 ? '0' : ''}${sc}`; }
        function formatDate(ts) { if (!ts) return ''; const d = ts.toDate ? ts.toDate() : new Date(ts); return d.toLocaleString('bg-BG'); }
        function getTimestampMs(ts) { return ts ? (ts.toMillis ? ts.toMillis() : ts.seconds * 1000) : 0; }
        function parseScoreValue(s) { if (!s) return { score: 0, total: 0 }; const p = s.split('/'); return { score: Number(p[0]) || 0, total: Number(p[1]) || 0 }; }
        function encodeQuizCode(quiz) { return btoa(unescape(encodeURIComponent(JSON.stringify(quiz)))); }
        function decodeQuizCode(c) { try { if (!c) return null; return JSON.parse(decodeURIComponent(escape(atob(c.trim().replace(/\s/g, ''))))); } catch (e) { return null; } }

        // –ü–æ–º–æ—â–Ω–∏ —Ä–µ—Ñ–µ—Ä–µ–Ω—Ü–∏–∏ –∫—ä–º Firestore (—Å–∞–º–æ –µ–¥–∏–Ω –≤–∏–¥ ‚Äì –±–µ–∑ legacy)
        const getTeacherSoloResultsCollection = (tid) => collection(db, 'artifacts', finalAppId, 'users', tid, 'solo_results');
        const getSessionRefById = (id) => doc(db, 'artifacts', finalAppId, 'public', 'data', 'sessions', id);
        const getParticipantsCollection = (id) => collection(db, 'artifacts', finalAppId, 'public', 'data', 'sessions', id, 'participants');
        const getParticipantRef = (sid, pid) => doc(db, 'artifacts', finalAppId, 'public', 'data', 'sessions', sid, 'participants', pid);
        const getUserQuizzesCollection = (uid) => collection(db, 'artifacts', finalAppId, 'users', uid, 'my_quizzes');
        const getUserQuizRef = (uid, qid) => doc(db, 'artifacts', finalAppId, 'users', uid, 'my_quizzes', qid);
        const getUserProfileRef = (uid) => doc(db, 'artifacts', finalAppId, 'users', uid, 'settings', 'profile');

        // ========== AUTH OBSERVER ==========
        onAuthStateChanged(auth, async (u) => {
            user = u;
            const loader = document.getElementById('auth-loader');
            if (u) {
                try {
                    const profileSnap = await getDoc(getUserProfileRef(u.uid));
                    isTeacher = profileSnap.exists() && profileSnap.data().role === 'teacher';
                    if (isTeacher) {
                        document.getElementById('user-email-display').innerText = u.email || '';
                        // –ê–∫–æ —Å–º–µ –Ω–∞ –Ω–∞—á–∞–ª–Ω–∏—è –µ–∫—Ä–∞–Ω, –º–æ–∂–µ –¥–∞ –ø—Ä–µ–≤–∫–ª—é—á–∏–º –∫—ä–º —Ç–∞–±–ª–æ—Ç–æ, –Ω–æ –Ω–µ–∫–∞ –æ—Å—Ç–∞–Ω–µ —Ä—ä—á–Ω–æ
                    }
                } catch (e) {
                    console.warn("–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ —á–µ—Ç–µ–Ω–µ –Ω–∞ –ø—Ä–æ—Ñ–∏–ª–∞", e);
                }
            } else {
                isTeacher = false;
            }
            loader.classList.add('hidden');
        });

        // ========== –ü–û–ö–ê–ó–í–ê–ù–ï –ù–ê –°–™–û–ë–©–ï–ù–ò–Ø ==========
        window.showMessage = (text, type = 'info') => {
            const container = document.getElementById('msg-container');
            if (!container) return;
            const msg = document.createElement('div');
            msg.className = `p-4 rounded-xl text-white shadow-lg mb-2 animate-pop ${type === 'error' ? 'bg-rose-500' : 'bg-indigo-600'}`;
            msg.innerText = text;
            container.appendChild(msg);
            setTimeout(() => msg.remove(), 3000);
        };

        // ========== –ü–†–ï–í–ö–õ–Æ–ß–í–ê–ù–ï –ú–ï–ñ–î–£ –ï–ö–†–ê–ù–ò ==========
        window.switchScreen = (screenName) => {
            // –°–∫—Ä–∏–≤–∞–º–µ –≤—Å–∏—á–∫–∏ –æ—Å–Ω–æ–≤–Ω–∏ –µ–∫—Ä–∞–Ω–∏
            document.querySelectorAll('#app > div[id^="screen-"]').forEach(d => d.classList.add('hidden'));
            const target = document.getElementById('screen-' + screenName);
            if (target) target.classList.remove('hidden');
            else console.warn("–õ–∏–ø—Å–≤–∞—â –µ–∫—Ä–∞–Ω:", screenName);

            // –°–ø–∏—Ä–∞–º–µ –≤—Å–∏—á–∫–∏ –ø–ª–µ–π—ä—Ä–∏
            if (player) { try { player.destroy(); } catch { } player = null; }
            if (solvePlayer) { try { solvePlayer.destroy(); } catch { } solvePlayer = null; }
            if (hostPlayer) { try { hostPlayer.destroy(); } catch { } hostPlayer = null; }

            // –°–ø–∏—Ä–∞–º–µ –≤—Å–∏—á–∫–∏ Firebase listeners
            unsubscribes.forEach(u => u());
            unsubscribes = [];

            // –°–ø–∏—Ä–∞–º–µ –≤—Å–∏—á–∫–∏ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∏
            activeIntervals.forEach(i => clearInterval(i));
            activeIntervals = [];

            // –ê–∫–æ –æ—Ç–∏–≤–∞–º–µ –∫—ä–º —Ç–∞–±–ª–æ—Ç–æ –Ω–∞ —É—á–∏—Ç–µ–ª, –ø—Ä–µ–∑–∞—Ä–µ–∂–¥–∞–º–µ –¥–∞–Ω–Ω–∏—Ç–µ
            if (screenName === 'teacher-dashboard' && user && isTeacher) {
                loadMyQuizzes();
                loadSoloResults();
            }

            // –û–±–Ω–æ–≤—è–≤–∞–º–µ –∏–∫–æ–Ω–∏—Ç–µ –Ω–∞ lucide
            if (window.lucide) lucide.createIcons();
            window.scrollTo(0, 0);
        };

        // –ü–æ–º–æ—â–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è –∑–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ –≤—Ä—ä—â–∞–Ω–µ –∫—ä–º –Ω–∞—á–∞–ª–Ω–∏—è –µ–∫—Ä–∞–Ω
        window.quitToWelcome = () => {
            window.switchScreen('welcome');
        };

        // ========== –£–ß–ò–¢–ï–õ–°–ö–ò –§–£–ù–ö–¶–ò–ò ==========
        window.toggleAuthMode = () => {
            authMode = authMode === 'login' ? 'register' : 'login';
            document.getElementById('auth-teacher-code-container').classList.toggle('hidden', authMode !== 'register');
            document.getElementById('auth-submit-btn').innerText = authMode === 'register' ? '–†–µ–≥–∏—Å—Ç—Ä–∏—Ä–∞–π —Å–µ' : '–í–ª–µ–∑';
        };

        window.handleAuthSubmit = async () => {
            const email = document.getElementById('auth-email').value;
            const password = document.getElementById('auth-password').value;
            if (!email || !password) return window.showMessage('–ü–æ–ø—ä–ª–Ω–µ—Ç–µ –≤—Å–∏—á–∫–∏ –ø–æ–ª–µ—Ç–∞!', 'error');
            try {
                if (authMode === 'register') {
                    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞ —É—á–∏—Ç–µ–ª—Å–∫–∏ –∫–æ–¥ (–æ–ø—Ä–æ—Å—Ç–µ–Ω–æ)
                    const code = document.getElementById('auth-teacher-code').value;
                    if (code !== 'vilidaf76') return window.showMessage('–ì—Ä–µ—à–µ–Ω –∫–æ–¥ –∑–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è!', 'error');
                    const cred = await createUserWithEmailAndPassword(auth, email, password);
                    await setDoc(getUserProfileRef(cred.user.uid), { role: 'teacher', email: email, emailNormalized: email.toLowerCase() });
                    window.showMessage('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è—Ç–∞ –µ —É—Å–ø–µ—à–Ω–∞!');
                } else {
                    await signInWithEmailAndPassword(auth, email, password);
                }
                window.switchScreen('teacher-dashboard');
            } catch (e) {
                window.showMessage('–ì—Ä–µ—à–∫–∞: ' + e.message, 'error');
            }
        };

        window.handleLogout = async () => {
            await signOut(auth);
            window.showMessage('–£—Å–ø–µ—à–µ–Ω –∏–∑—Ö–æ–¥.');
            window.switchScreen('welcome');
        };

        // –ó–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ —É—Ä–æ—Ü–∏—Ç–µ –Ω–∞ —É—á–∏—Ç–µ–ª—è
        function loadMyQuizzes() {
            if (!user) return;
            const unsub = onSnapshot(getUserQuizzesCollection(user.uid), (snap) => {
                myQuizzes = snap.docs.map(d => ({ ...d.data(), id: d.id }));
                renderMyQuizzes();
            });
            unsubscribes.push(unsub);
        }

        function renderMyQuizzes() {
            const container = document.getElementById('my-quizzes-list');
            if (!container) return;
            if (myQuizzes.length === 0) {
                container.innerHTML = '<div class="col-span-full text-center py-10 text-slate-400 font-bold">–í—Å–µ –æ—â–µ –Ω—è–º–∞—Ç–µ —Å—ä–∑–¥–∞–¥–µ–Ω–∏ —É—Ä–æ—Ü–∏.</div>';
                return;
            }
            container.innerHTML = myQuizzes.map(q => `
                <div class="bg-white p-5 rounded-2xl border border-slate-100 shadow-sm hover:shadow-md transition-all flex flex-col sm:flex-row justify-between items-center gap-4">
                    <div class="truncate w-full text-center sm:text-left">
                        <h4 class="font-black text-slate-800 truncate text-lg">${q.title || '–ë–µ–∑ –∑–∞–≥–ª–∞–≤–∏–µ'}</h4>
                        <p class="text-[10px] text-slate-400 font-black uppercase tracking-widest bg-slate-50 inline-block px-2 py-1 rounded-md mt-1">${q.questions?.length || 0} –í–™–ü–†–û–°–ê</p>
                    </div>
                    <div class="flex items-center gap-2">
                        <button onclick="window.startHostFromLibrary('${q.id}')" title="–°—Ç–∞—Ä—Ç" class="p-3 bg-indigo-50 text-indigo-600 rounded-xl hover:bg-indigo-600 hover:text-white transition-all"><i data-lucide="play" class="w-5 h-5"></i></button>
                        <button onclick="window.editQuiz('${q.id}')" title="–†–µ–¥–∞–∫—Ü–∏—è" class="p-3 bg-white text-slate-400 border border-slate-200 rounded-xl hover:border-brand-500 hover:text-brand-500 transition-all"><i data-lucide="pencil" class="w-5 h-5"></i></button>
                        <button onclick="window.showShareCode('${q.id}')" title="–ö–æ–¥" class="p-3 bg-amber-50 text-amber-600 rounded-xl hover:bg-amber-500 hover:text-white transition-all"><i data-lucide="share-2" class="w-5 h-5"></i></button>
                        <button onclick="window.deleteQuiz('${q.id}')" title="–ò–∑—Ç—Ä–∏–π" class="p-3 bg-rose-50 text-rose-500 rounded-xl hover:bg-rose-500 hover:text-white transition-all"><i data-lucide="trash-2" class="w-5 h-5"></i></button>
                    </div>
                </div>`).join('');
            lucide.createIcons();
        }

        window.deleteQuiz = async (id) => {
            if (!confirm('–°–∏–≥—É—Ä–Ω–∏ –ª–∏ —Å—Ç–µ, —á–µ –∏—Å–∫–∞—Ç–µ –¥–∞ –∏–∑—Ç—Ä–∏–µ—Ç–µ —Ç–æ–∑–∏ —É—Ä–æ–∫?')) return;
            await deleteDoc(getUserQuizRef(user.uid, id));
            window.showMessage('–£—Ä–æ–∫—ä—Ç –µ –∏–∑—Ç—Ä–∏—Ç.');
        };

        window.startHostFromLibrary = async (id) => {
            const quiz = myQuizzes.find(x => x.id === id);
            if (!quiz) return;
            currentQuiz = { v: quiz.v, q: quiz.questions || [], title: quiz.title };
            currentQuizOwnerId = user.uid;
            await openLiveHost();
        };

        // –ó–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ —Ä–µ–∑—É–ª—Ç–∞—Ç–∏ –æ—Ç —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª–Ω–∞ —Ä–∞–±–æ—Ç–∞
        function loadSoloResults() {
            if (!user) return;
            const unsub = onSnapshot(collection(db, 'artifacts', finalAppId, 'users', user.uid, 'solo_results'), (snap) => {
                soloResults = snap.docs.map(d => ({ ...d.data(), id: d.id }));
                renderSoloResults();
            });
            unsubscribes.push(unsub);
        }

        function renderSoloResults() {
            const tbody = document.getElementById('solo-results-body');
            if (!tbody) return;
            const sorted = [...soloResults].sort((a, b) => getTimestampMs(b.timestamp) - getTimestampMs(a.timestamp));
            if (sorted.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="p-8 text-center text-slate-400 font-bold">–í—Å–µ –æ—â–µ –Ω—è–º–∞ —Ä–µ–∑—É–ª—Ç–∞—Ç–∏.</td></tr>';
                return;
            }
            tbody.innerHTML = sorted.map(r => `<tr class="border-b text-xs hover:bg-slate-50 transition-colors">
                <td class="p-4 font-bold text-slate-700">${r.studentName}</td>
                <td class="p-4 text-slate-500 truncate max-w-[120px]">${r.quizTitle}</td>
                <td class="p-4 text-slate-400 font-mono">${formatDate(r.timestamp)}</td>
                <td class="p-4 text-right"><span class="bg-indigo-50 text-indigo-700 px-2 py-1 rounded-md font-black">${r.score}</span></td>
                <td class="p-4 text-center"><button onclick="window.deleteSoloResult('${r.id}')" class="text-rose-300 hover:text-rose-500 transition-colors"><i data-lucide="trash-2" class="w-4 h-4"></i></button></td>
            </tr>`).join('');
            lucide.createIcons();
        }

        window.deleteSoloResult = async (id) => {
            if (!confirm('–ò–∑—Ç—Ä–∏–≤–∞–Ω–µ –Ω–∞ —Ä–µ–∑—É–ª—Ç–∞—Ç–∞?')) return;
            await deleteDoc(doc(db, 'artifacts', finalAppId, 'users', user.uid, 'solo_results', id));
            window.showMessage('–†–µ–∑—É–ª—Ç–∞—Ç—ä—Ç –µ –∏–∑—Ç—Ä–∏—Ç.');
        };

        window.exportSoloResultsExcel = () => {
            const data = soloResults.map(r => ({
                –£—á–µ–Ω–∏–∫: r.studentName,
                –£—Ä–æ–∫: r.quizTitle,
                –î–∞—Ç–∞: formatDate(r.timestamp),
                –†–µ–∑—É–ª—Ç–∞—Ç: r.score
            }));
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, '–†–µ–∑—É–ª—Ç–∞—Ç–∏');
            XLSX.writeFile(wb, 'SoloResults.xlsx');
        };

        // ========== –†–ï–î–ê–ö–¢–û–† ==========
        window.loadEditorVideo = (keepQuestions = false) => {
            const url = document.getElementById('yt-url').value;
            const match = url.match(/(?:youtu\.be\/|youtube\.com(?:\/embed\/|\/v\/|\/watch\?v=|\/watch\?.+&v=))([\w-]{11})/);
            if (!match) {
                window.showMessage('–ù–µ–≤–∞–ª–∏–¥–µ–Ω YouTube –ª–∏–Ω–∫!', 'error');
                return;
            }
            currentVideoId = match[1];
            document.getElementById('editor-view').classList.add('hidden');
            document.getElementById('editor-player-container').innerHTML = '<div id="player"></div>';
            player = new YT.Player('player', { videoId: currentVideoId });
            if (!keepQuestions) {
                questions = [];
                renderEditorList();
            }
        };

        window.openQuestionModal = () => {
            document.getElementById('m-title-text').innerText = '–ù–æ–≤ –≤—ä–ø—Ä–æ—Å';
            document.getElementById('m-text').value = '';
            document.getElementById('m-type').value = 'single';
            document.getElementById('m-points').value = '1';
            updateModalFields();
            document.getElementById('modal-q').classList.remove('hidden');
            document.getElementById('modal-q').classList.add('flex');
        };

        window.updateModalFields = () => {
            const type = document.getElementById('m-type').value;
            const container = document.getElementById('m-opts-container');
            container.innerHTML = '';
            if (type === 'single' || type === 'multiple') {
                const html = ['A', 'B', 'C', 'D'].map((letter, idx) => `
                    <div class="flex items-center gap-3 mb-3">
                        <span class="font-bold text-slate-400 w-6">${letter}</span>
                        <input type="text" placeholder="–¢–µ–∫—Å—Ç –Ω–∞ –æ—Ç–≥–æ–≤–æ—Ä–∞ ${idx+1}" class="flex-1 p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm font-bold option-text" data-opt-index="${idx}">
                        ${type === 'single' 
                            ? `<input type="radio" name="correct-opt" value="${idx}" class="w-5 h-5 accent-brand-600">` 
                            : `<input type="checkbox" class="w-5 h-5 accent-brand-600 correct-multi">`}
                    </div>
                `).join('');
                container.innerHTML = html;
            } else if (type === 'boolean') {
                container.innerHTML = `
                    <div class="flex gap-4">
                        <label class="flex-1 p-3 bg-emerald-50 rounded-xl border border-emerald-200 cursor-pointer flex items-center justify-center gap-2 font-bold text-emerald-700">
                            <input type="radio" name="correct-bool" value="true" checked> –î–ê
                        </label>
                        <label class="flex-1 p-3 bg-rose-50 rounded-xl border border-rose-200 cursor-pointer flex items-center justify-center gap-2 font-bold text-rose-700">
                            <input type="radio" name="correct-bool" value="false"> –ù–ï
                        </label>
                    </div>
                `;
            } else {
                container.innerHTML = '<p class="text-center text-slate-400">–û—Ç–≤–æ—Ä–µ–Ω –≤—ä–ø—Ä–æ—Å ‚Äì –æ—Ç–≥–æ–≤–æ—Ä—ä—Ç —Å–µ –ø—Ä–æ–≤–µ—Ä—è–≤–∞ —Ä—ä—á–Ω–æ.</p>';
            }
        };

        window.saveQuestion = () => {
            const text = document.getElementById('m-text').value.trim();
            if (!text) return window.showMessage('–í—ä–≤–µ–¥–µ—Ç–µ —Ç–µ–∫—Å—Ç –Ω–∞ –≤—ä–ø—Ä–æ—Å–∞!', 'error');
            const type = document.getElementById('m-type').value;
            const points = parseInt(document.getElementById('m-points').value) || 1;
            const time = player ? Math.floor(player.getCurrentTime()) : 0;
            
            let correct = null;
            let options = [];

            if (type === 'single') {
                options = [];
                const optionInputs = document.querySelectorAll('#m-opts-container .option-text');
                optionInputs.forEach(inp => options.push(inp.value.trim() || '...'));
                const selected = document.querySelector('input[name="correct-opt"]:checked');
                if (!selected) return window.showMessage('–ú–∞—Ä–∫–∏—Ä–∞–π—Ç–µ –≤–µ—Ä–Ω–∏—è –æ—Ç–≥–æ–≤–æ—Ä!', 'error');
                correct = parseInt(selected.value);
            } else if (type === 'multiple') {
                options = [];
                const optionInputs = document.querySelectorAll('#m-opts-container .option-text');
                optionInputs.forEach(inp => options.push(inp.value.trim() || '...'));
                const checkboxes = document.querySelectorAll('.correct-multi');
                correct = [];
                checkboxes.forEach((cb, idx) => { if (cb.checked) correct.push(idx); });
                if (correct.length === 0) return window.showMessage('–ú–∞—Ä–∫–∏—Ä–∞–π—Ç–µ –ø–æ–Ω–µ –µ–¥–∏–Ω –≤–µ—Ä–µ–Ω –æ—Ç–≥–æ–≤–æ—Ä!', 'error');
            } else if (type === 'boolean') {
                options = ['–î–ê', '–ù–ï'];
                const selected = document.querySelector('input[name="correct-bool"]:checked');
                correct = selected ? (selected.value === 'true') : true;
            } else {
                // open ‚Äì –±–µ–∑ –æ–ø—Ü–∏–∏
                options = [];
                correct = null;
            }

            const question = { time, text, type, points, options, correct };
            questions.push(question);
            questions.sort((a, b) => a.time - b.time);
            renderEditorList();
            document.getElementById('modal-q').classList.add('hidden');
            window.showMessage('–í—ä–ø—Ä–æ—Å—ä—Ç –µ –¥–æ–±–∞–≤–µ–Ω!');
        };

        function renderEditorList() {
            const list = document.getElementById('q-list');
            if (!list) return;
            if (questions.length === 0) {
                list.innerHTML = '<div class="text-center py-10 text-slate-400 text-sm italic">–í—Å–µ –æ—â–µ –Ω—è–º–∞ –¥–æ–±–∞–≤–µ–Ω–∏ –≤—ä–ø—Ä–æ—Å–∏.</div>';
                return;
            }
            list.innerHTML = questions.map((q, i) => `
                <div class="p-3 bg-white border border-slate-100 shadow-sm rounded-xl mb-3 flex justify-between items-center group">
                    <div class="flex items-center gap-3">
                        <span class="font-mono font-bold text-brand-600 bg-brand-50 px-2 py-1 rounded-lg text-xs">${formatTime(q.time)}</span>
                        <span class="truncate w-32 font-bold text-slate-700 text-sm">${q.text}</span>
                    </div>
                    <div class="flex gap-1">
                        <button onclick="window.editQuestion(${i})" class="text-slate-300 hover:text-brand-500 transition-colors p-1"><i data-lucide="pencil" class="w-4 h-4"></i></button>
                        <button onclick="window.deleteQuestion(${i})" class="text-slate-300 hover:text-rose-500 transition-colors p-1"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </div>
                </div>`).join('');
            lucide.createIcons();
        }

        window.deleteQuestion = (index) => {
            questions.splice(index, 1);
            renderEditorList();
        };

        window.editQuestion = (index) => {
            const q = questions[index];
            // TODO: –∏–º–ø–ª–µ–º–µ–Ω—Ç–∏—Ä–∞–π edit ‚Äì –∑–∞—Å–µ–≥–∞ —Å–∞–º–æ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
            window.showMessage('–†–µ–¥–∞–∫—Ü–∏—è—Ç–∞ –≤—Å–µ –æ—â–µ –Ω–µ –µ –∏–º–ø–ª–µ–º–µ–Ω—Ç–∏—Ä–∞–Ω–∞, –∏–∑—Ç—Ä–∏–π—Ç–µ –∏ —Å—ä–∑–¥–∞–π—Ç–µ –Ω–∞–Ω–æ–≤–æ.', 'info');
        };

        // –ó–∞–ø–∞–∑–≤–∞–Ω–µ –Ω–∞ —É—Ä–æ–∫–∞
        window.saveQuizToLibrary = () => {
            if (!user) return window.showMessage('–ù—è–º–∞—Ç–µ –≤—Ö–æ–¥!', 'error');
            if (questions.length === 0) return window.showMessage('–î–æ–±–∞–≤–µ—Ç–µ –ø–æ–Ω–µ –µ–¥–∏–Ω –≤—ä–ø—Ä–æ—Å!', 'error');
            if (!currentVideoId) return window.showMessage('–ó–∞—Ä–µ–¥–µ—Ç–µ YouTube –≤–∏–¥–µ–æ!', 'error');
            document.getElementById('modal-save-quiz').classList.remove('hidden');
            document.getElementById('modal-save-quiz').classList.add('flex');
            document.getElementById('save-quiz-title').value = '';
        };

        window.performSaveQuiz = async () => {
            const title = document.getElementById('save-quiz-title').value.trim();
            if (!title) return window.showMessage('–í—ä–≤–µ–¥–µ—Ç–µ –∑–∞–≥–ª–∞–≤–∏–µ!', 'error');
            try {
                const data = { title, v: currentVideoId, questions, updatedAt: serverTimestamp() };
                if (editingQuizId) {
                    await updateDoc(getUserQuizRef(user.uid, editingQuizId), data);
                    window.showMessage('–£—Ä–æ–∫—ä—Ç –µ –æ–±–Ω–æ–≤–µ–Ω!');
                } else {
                    await addDoc(getUserQuizzesCollection(user.uid), { ...data, createdAt: serverTimestamp() });
                    window.showMessage('–£—Ä–æ–∫—ä—Ç –µ –∑–∞–ø–∞–∑–µ–Ω!');
                }
                document.getElementById('modal-save-quiz').classList.add('hidden');
                window.switchScreen('teacher-dashboard');
            } catch (e) {
                window.showMessage('–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∑–∞–ø–∏—Å: ' + e.message, 'error');
            }
        };

        window.editQuiz = (id) => {
            const quiz = myQuizzes.find(x => x.id === id);
            if (!quiz) return;
            editingQuizId = id;
            questions = quiz.questions || [];
            currentVideoId = quiz.v;
            window.switchScreen('create');
            document.getElementById('yt-url').value = `https://youtu.be/${quiz.v}`;
            window.loadEditorVideo(true);
        };

        window.showShareCode = (id) => {
            const quiz = myQuizzes.find(x => x.id === id);
            if (!quiz) return;
            const codeObj = { v: quiz.v, q: quiz.questions, title: quiz.title, ownerId: user.uid };
            const code = encodeQuizCode(codeObj);
            document.getElementById('share-code-display').value = code;
            document.getElementById('modal-share').classList.remove('hidden');
        };

        window.copyShareCode = () => {
            const input = document.getElementById('share-code-display');
            input.select();
            document.execCommand('copy');
            window.showMessage('–ö–æ–¥—ä—Ç –µ –∫–æ–ø–∏—Ä–∞–Ω!');
        };

        window.openImportModal = () => {
            document.getElementById('import-code-input').value = '';
            document.getElementById('modal-import').classList.remove('hidden');
        };

        window.submitImport = () => {
            const code = document.getElementById('import-code-input').value.trim();
            const decoded = decodeQuizCode(code);
            if (!decoded) return window.showMessage('–ù–µ–≤–∞–ª–∏–¥–µ–Ω –∫–æ–¥!', 'error');
            if (!decoded.v || !decoded.q) return window.showMessage('–ö–æ–¥—ä—Ç –Ω–µ —Å—ä–¥—ä—Ä–∂–∞ –≤–∞–ª–∏–¥–µ–Ω —É—Ä–æ–∫.', 'error');
            // –ó–∞–ø–∞–∑–∏ –∫–∞—Ç–æ –Ω–æ–≤ —É—Ä–æ–∫
            const newQuiz = { title: decoded.title || '–ò–º–ø–æ—Ä—Ç–∏—Ä–∞–Ω —É—Ä–æ–∫', v: decoded.v, questions: decoded.q || [] };
            addDoc(getUserQuizzesCollection(user.uid), { ...newQuiz, createdAt: serverTimestamp() }).then(() => {
                window.showMessage('–£—Ä–æ–∫—ä—Ç –µ –∏–º–ø–æ—Ä—Ç–∏—Ä–∞–Ω —É—Å–ø–µ—à–Ω–æ!');
                document.getElementById('modal-import').classList.add('hidden');
            }).catch(e => window.showMessage('–ì—Ä–µ—à–∫–∞: ' + e.message, 'error'));
        };

        // ========== –°–û–õ–û –ò–ì–†–ê ==========
        window.startIndividual = async () => {
            const code = document.getElementById('ind-quiz-code').value.trim().replace(/\s/g, '');
            if (!code) return window.showMessage('–í—ä–≤–µ–¥–µ—Ç–µ –∫–æ–¥!', 'error');
            const decoded = decodeQuizCode(code);
            if (!decoded || !decoded.v) return window.showMessage('–ù–µ–≤–∞–ª–∏–¥–µ–Ω –∫–æ–¥', 'error');
            
            currentQuiz = decoded;
            sopModeEnabled = document.getElementById('ind-sop-mode').checked;
            isDiscussionMode = document.getElementById('ind-discussion-mode').checked;
            studentNameValue = isDiscussionMode ? '–î–∏—Å–∫—É—Å–∏—è' : (prompt('–í–∞—à–µ—Ç–æ –∏–º–µ:') || '–ê–Ω–æ–Ω–∏–º–µ–Ω');
            if (!studentNameValue) return;

            // –ù—É–ª–∏—Ä–∞–Ω–µ –Ω–∞ –ø—Ä–æ–º–µ–Ω–ª–∏–≤–∏ –∑–∞ —Å–æ–ª–æ
            scoreCount = 0;
            lastAnsweredIdx = -1;
            soloGameFinished = false;
            currentQuizOwnerId = decoded.ownerId || null;

            if (!auth.currentUser) await signInAnonymously(auth);
            window.switchScreen('solve');

            setTimeout(() => {
                document.getElementById('solve-player-container').innerHTML = '<div id="solve-player"></div>';
                solvePlayer = new YT.Player('solve-player', {
                    videoId: currentQuiz.v,
                    width: '100%',
                    height: '100%',
                    playerVars: { autoplay: 1 },
                    events: {
                        onStateChange: (e) => {
                            if (e.data === YT.PlayerState.PLAYING) {
                                // –°–ø–∏—Ä–∞–º–µ –≤—Å–∏—á–∫–∏ —Å—Ç–∞—Ä–∏ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∏
                                activeIntervals.forEach(clearInterval);
                                activeIntervals = [];
                                const interval = setInterval(() => {
                                    if (!solvePlayer || !solvePlayer.getCurrentTime) return;
                                    const t = Math.floor(solvePlayer.getCurrentTime());
                                    // –¢—ä—Ä—Å–∏–º –≤—ä–ø—Ä–æ—Å, —á–∏–µ—Ç–æ –≤—Ä–µ–º–µ –µ –º–µ–∂–¥—É –ø–æ—Å–ª–µ–¥–Ω–∏—è –æ—Ç–≥–æ–≤–æ—Ä–µ–Ω –∏ —Ç–µ–∫—É—â–æ—Ç–æ –≤—Ä–µ–º–µ
                                    const nextQ = currentQuiz.q.find(q => q.time > lastAnsweredIdx && q.time <= t);
                                    if (nextQ) {
                                        lastAnsweredIdx = nextQ.time;
                                        triggerSoloQuestion(nextQ);
                                    }
                                    if (solvePlayer.getDuration() > 0 && t >= solvePlayer.getDuration() - 1) {
                                        finishSoloGame();
                                    }
                                }, 500);
                                activeIntervals.push(interval);
                            } else if (e.data === YT.PlayerState.ENDED) {
                                finishSoloGame();
                            }
                        }
                    }
                });
            }, 500);
        };

        function triggerSoloQuestion(q) {
            if (soloGameFinished) return;
            solvePlayer.pauseVideo();
            const overlay = document.getElementById('ind-overlay');
            overlay.classList.remove('hidden');
            overlay.classList.add('flex');
            const qText = document.getElementById('ind-overlay-q-text');
            qText.innerText = q.text;
            if (sopModeEnabled && 'speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(q.text);
                utterance.lang = 'bg-BG';
                window.speechSynthesis.speak(utterance);
            }
            const optionsDiv = document.getElementById('ind-overlay-options');
            optionsDiv.innerHTML = '';

            if (q.type === 'single' || q.type === 'boolean') {
                const opts = q.type === 'boolean' ? ['–î–ê', '–ù–ï'] : q.options;
                optionsDiv.innerHTML = opts.map((opt, i) => `
                    <button onclick="window.submitSoloAnswer(${i})" class="w-full p-5 bg-white/10 hover:bg-white/20 border border-white/20 rounded-2xl text-white font-bold text-left backdrop-blur-sm pointer-events-auto transition-all hover:scale-[1.02]">
                        ${opt}
                    </button>
                `).join('');
            } else {
                optionsDiv.innerHTML = '<button onclick="window.submitSoloAnswer(null)" class="w-full p-5 bg-brand-600 text-white rounded-xl pointer-events-auto shadow-lg hover:bg-brand-500">–ü—Ä–æ–¥—ä–ª–∂–∏</button>';
            }
        }

        window.submitSoloAnswer = (selectedIndex) => {
            if (!currentQuiz || !currentQuiz.q) return;
            // –ù–∞–º–∏—Ä–∞–º–µ –≤—ä–ø—Ä–æ—Å–∞, –∫–æ–π—Ç–æ —Å–µ –ø–æ–∫–∞–∑–≤–∞ (–ø–æ—Å–ª–µ–¥–Ω–∏—è—Ç –∑–∞–¥–µ–π—Å—Ç–≤–∞–Ω)
            const currentQ = currentQuiz.q.find(q => q.time === lastAnsweredIdx);
            if (!currentQ) return;

            let isCorrect = false;
            if (currentQ.type === 'single' || currentQ.type === 'boolean') {
                isCorrect = (selectedIndex === currentQ.correct);
            } else if (currentQ.type === 'multiple') {
                isCorrect = Array.isArray(currentQ.correct) && currentQ.correct.includes(selectedIndex);
            } else {
                isCorrect = true; // –æ—Ç–≤–æ—Ä–µ–Ω –≤—ä–ø—Ä–æ—Å ‚Äì –≤–∏–Ω–∞–≥–∏ –≤–µ—Ä–µ–Ω
            }

            if (isCorrect) {
                scoreCount += (currentQ.points || 1);
                window.showMessage('‚úÖ –í–µ—Ä–µ–Ω –æ—Ç–≥–æ–≤–æ—Ä!', 'success');
            } else {
                window.showMessage('‚ùå –ì—Ä–µ—à–µ–Ω –æ—Ç–≥–æ–≤–æ—Ä.', 'error');
            }

            // –°–∫—Ä–∏–≤–∞–º–µ overlay
            document.getElementById('ind-overlay').classList.add('hidden');
            if (window.speechSynthesis) window.speechSynthesis.cancel();

            // –ü—Ä–æ–¥—ä–ª–∂–∞–≤–∞–º–µ –≤–∏–¥–µ–æ—Ç–æ
            setTimeout(() => {
                if (solvePlayer && solvePlayer.playVideo) solvePlayer.playVideo();
            }, 500);
        };

        function finishSoloGame() {
            if (soloGameFinished) return;
            soloGameFinished = true;
            activeIntervals.forEach(clearInterval);
            window.switchScreen('finish');
            const totalPoints = currentQuiz.q.reduce((acc, q) => acc + (q.points || 1), 0);
            document.getElementById('res-score').innerText = `${scoreCount} / ${totalPoints}`;
            
            // –ó–∞–ø–∏—Å –Ω–∞ —Ä–µ–∑—É–ª—Ç–∞—Ç–∞ (–∞–∫–æ –Ω–µ –µ —Ä–µ–∂–∏–º –æ–±—Å—ä–∂–¥–∞–Ω–µ –∏ –∏–º–∞ ownerId)
            if (!isDiscussionMode && auth.currentUser && currentQuizOwnerId) {
                try {
                    const resultData = {
                        studentName: studentNameValue,
                        quizTitle: currentQuiz.title + (sopModeEnabled ? ' (–°–û–ü)' : ''),
                        score: `${scoreCount}/${totalPoints}`,
                        timestamp: serverTimestamp(),
                        userId: auth.currentUser.uid
                    };
                    // –ò–∑–ø–æ–ª–∑–≤–∞–º–µ addDoc –∑–∞ —É–Ω–∏–∫–∞–ª–µ–Ω ID
                    addDoc(getTeacherSoloResultsCollection(currentQuizOwnerId), resultData);
                } catch (e) {
                    console.warn('–ù–µ—É—Å–ø–µ—à–µ–Ω –∑–∞–ø–∏—Å –Ω–∞ —Ä–µ–∑—É–ª—Ç–∞—Ç:', e);
                }
            }
        }

        // ========== –ù–ê –ñ–ò–í–û (–•–û–°–¢) ==========
        async function openLiveHost() {
            if (!user) return;
            sessionID = Math.floor(1000 + Math.random() * 9000).toString();
            sessionDocId = sessionID;
            window.switchScreen('live-host');
            document.getElementById('host-pin').innerText = sessionID;

            const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(window.location.origin + window.location.pathname + '?pin=' + sessionID)}`;
            document.getElementById('host-qr-container').innerHTML = `
                <div class="text-[10px] uppercase font-black text-slate-400 mb-2 tracking-widest">QR –í—Ö–æ–¥</div>
                <img src="${qrUrl}" class="w-32 h-32 rounded-xl border-4 border-indigo-50 shadow-md">
                <div class="text-[9px] text-slate-300 mt-2 font-mono">–°–∫–∞–Ω–∏—Ä–∞–π—Ç–µ</div>
            `;

            await setDoc(getSessionRefById(sessionDocId), {
                activeQ: -1,
                status: 'waiting',
                hostId: user.uid,
                pin: sessionID,
                timestamp: serverTimestamp()
            });

            lastFetchedParticipants = [];

            // –°–ª—É—à–∞–º–µ –∑–∞ —É—á–∞—Å—Ç–Ω–∏—Ü–∏ –≤ —Å–µ—Å–∏—è—Ç–∞
            const unsubParticipants = onSnapshot(getParticipantsCollection(sessionDocId), (snap) => {
                lastFetchedParticipants = snap.docs.map(d => ({ ...d.data(), id: d.id }));
                renderHostDashboard();
            });
            unsubscribes.push(unsubParticipants);
        }

        window.initHostPlayer = () => {
            if (!window.YT) { setTimeout(window.initHostPlayer, 500); return; }
            document.getElementById('host-video-container').innerHTML = '<div id="host-video"></div>';
            document.getElementById('host-setup-area').classList.add('hidden');
            document.getElementById('host-stats-bar').classList.remove('hidden');
            
            hostPlayer = new YT.Player('host-video', {
                videoId: currentQuiz.v,
                width: '100%',
                height: '100%',
                playerVars: { autoplay: 1 },
                events: {
                    onStateChange: (e) => {
                        if (e.data === YT.PlayerState.PLAYING) {
                            activeIntervals.forEach(clearInterval);
                            activeIntervals = [];
                            const interval = setInterval(() => {
                                if (!hostPlayer || !hostPlayer.getCurrentTime) return;
                                const t = Math.floor(hostPlayer.getCurrentTime());
                                document.getElementById('host-timer').innerText = formatTime(t);
                                const qIdx = currentQuiz.q.findIndex(q => Math.abs(q.time - t) <= 1);
                                if (qIdx !== -1 && qIdx !== liveActiveQIdx) {
                                    liveActiveQIdx = qIdx;
                                    hostPlayer.pauseVideo();
                                    updateDoc(getSessionRefById(sessionDocId), {
                                        activeQ: qIdx,
                                        qData: currentQuiz.q[qIdx],
                                        status: 'active'
                                    });
                                }
                            }, 1000);
                            activeIntervals.push(interval);
                        }
                    }
                }
            });
        };

        function renderHostDashboard() {
            document.getElementById('host-participant-count').innerText = lastFetchedParticipants.length;
            const sorted = [...lastFetchedParticipants].sort((a, b) => (b.score || 0) - (a.score || 0));
            const tbody = document.getElementById('host-results-body');
            tbody.innerHTML = sorted.map((p, i) => `
                <tr class="border-b text-xs last:border-0 hover:bg-slate-50 transition-colors">
                    <td class="p-3 flex items-center gap-3">
                        <span class="text-slate-300 font-mono">${i+1}.</span>
                        <span class="text-lg bg-white rounded-full w-8 h-8 flex items-center justify-center shadow-sm border border-slate-100">${p.avatar || 'üë§'}</span>
                        <span class="font-bold text-slate-700">${p.name}</span>
                    </td>
                    <td class="p-3 text-right"><span class="bg-indigo-50 text-indigo-700 px-2 py-1 rounded font-black">${p.score || 0}</span></td>
                    <td class="p-3 text-center">
                        <button onclick="window.deleteParticipant('${p.id}')" class="text-slate-300 hover:text-rose-500 transition-colors"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </td>
                </tr>`).join('');
            lucide.createIcons();
        }

        window.deleteParticipant = async (pid) => {
            if (!confirm('–ü—Ä–µ–º–∞—Ö–≤–∞–Ω–µ –Ω–∞ —É—á–∞—Å—Ç–Ω–∏–∫?')) return;
            await deleteDoc(getParticipantRef(sessionDocId, pid));
        };

        window.finishLiveSession = async () => {
            await updateDoc(getSessionRefById(sessionDocId), { status: 'finished' });
            document.getElementById('export-buttons-container').classList.remove('hidden');
            document.getElementById('export-buttons-container').classList.add('flex');
            window.showMessage('–°–µ—Å–∏—è—Ç–∞ –ø—Ä–∏–∫–ª—é—á–∏. –ú–æ–∂–µ—Ç–µ –¥–∞ –µ–∫—Å–ø–æ—Ä—Ç–∏—Ä–∞—Ç–µ —Ä–µ–∑—É–ª—Ç–∞—Ç–∏—Ç–µ.');
        };

        window.quitHostSession = async () => {
            if (!confirm('–°–∏–≥—É—Ä–Ω–∏ –ª–∏ —Å—Ç–µ, —á–µ –∏—Å–∫–∞—Ç–µ –¥–∞ –ø—Ä–µ–∫—Ä–∞—Ç–∏—Ç–µ —Å–µ—Å–∏—è—Ç–∞?')) return;
            await updateDoc(getSessionRefById(sessionDocId), { status: 'finished' });
            window.switchScreen('teacher-dashboard');
        };

        // –ï–∫—Å–ø–æ—Ä—Ç
        function getExpData() {
            return lastFetchedParticipants.map(p => ({ Name: p.name, Score: p.score || 0 }));
        }

        window.exportExcel = () => {
            const ws = XLSX.utils.json_to_sheet(getExpData());
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, '–†–µ–∑—É–ª—Ç–∞—Ç–∏');
            XLSX.writeFile(wb, `QuizResults_${sessionID}.xlsx`);
        };

        window.exportPDF = async () => {
            window.showMessage('–ì–µ–Ω–µ—Ä–∏—Ä–∞–Ω–µ –Ω–∞ PDF...', 'info');
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.text(`–†–µ–∑—É–ª—Ç–∞—Ç–∏ –æ—Ç —Å–µ—Å–∏—è ${sessionID}`, 10, 10);
            doc.autoTable({
                head: [['–ò–º–µ', '–¢–æ—á–∫–∏']],
                body: getExpData().map(d => [d.Name, d.Score]),
                styles: { font: 'helvetica' }
            });
            doc.save(`Results_${sessionID}.pdf`);
        };

        // ========== –ù–ê –ñ–ò–í–û (–£–ß–ï–ù–ò–ö) ==========
        window.joinLiveSession = async () => {
            const pin = document.getElementById('live-pin').value.trim();
            const name = document.getElementById('live-student-name').value.trim();
            if (!pin || !name) return window.showMessage('–ü–æ–ø—ä–ª–Ω–µ—Ç–µ –ü–ò–ù –∏ –∏–º–µ!', 'error');
            window.showMessage('–°–≤—ä—Ä–∑–≤–∞–Ω–µ...');

            if (!auth.currentUser) await signInAnonymously(auth);

            const sessionSnap = await getDoc(getSessionRefById(pin));
            if (!sessionSnap.exists()) return window.showMessage('–ù–µ–≤–∞–ª–∏–¥–µ–Ω –ü–ò–ù', 'error');

            sessionID = pin;
            sessionDocId = pin;
            studentNameValue = name;
            liveScore = 0;
            liveActiveQIdx = -1;
            lastAnsweredIdx = -1;

            window.switchScreen('live-client');

            const avatar = AVATARS[Math.floor(Math.random() * AVATARS.length)];
            document.getElementById('my-avatar-display').innerText = avatar;

            const participantData = {
                name,
                sessionId: pin,
                avatar,
                score: 0,
                answers: {},
                joinedAt: serverTimestamp()
            };

            try {
                await setDoc(getParticipantRef(pin, auth.currentUser.uid), participantData, { merge: true });
            } catch (e) {
                window.showMessage('–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∑–∞–ø–∏—Å: ' + e.message, 'error');
                return;
            }

            // –°–ª—É—à–∞–º–µ –∑–∞ –ø—Ä–æ–º–µ–Ω–∏ –≤ —Å–µ—Å–∏—è—Ç–∞
            const unsubSession = onSnapshot(getSessionRefById(pin), (snap) => {
                const data = snap.data();
                if (!data) return;
                if (data.status === 'finished') {
                    document.getElementById('client-question').classList.add('hidden');
                    document.getElementById('client-waiting').classList.add('hidden');
                    document.getElementById('client-finished').classList.remove('hidden');
                    document.getElementById('final-score-display').innerText = liveScore;
                } else if (data.status === 'active' && data.activeQ !== liveActiveQIdx) {
                    liveActiveQIdx = data.activeQ;
                    liveCurrentQ = data.qData;
                    document.getElementById('client-question').classList.remove('hidden');
                    document.getElementById('client-waiting').classList.add('hidden');
                    document.getElementById('live-q-text-client').innerText = data.qData.text;
                    renderLiveQuestionUI(data.qData);
                } else if (data.status !== 'active') {
                    document.getElementById('client-question').classList.add('hidden');
                    document.getElementById('client-waiting').classList.remove('hidden');
                }
            });
            unsubscribes.push(unsubSession);
        };

        function renderLiveQuestionUI(q) {
            const container = document.getElementById('live-options-client');
            container.innerHTML = '';
            if (q.type === 'single' || q.type === 'boolean') {
                const opts = q.type === 'boolean' ? ['–î–ê', '–ù–ï'] : q.options;
                container.innerHTML = opts.map((opt, i) => `
                    <button onclick="window.submitLiveAnswer(${i})" class="w-full p-5 bg-white border-2 border-indigo-50 rounded-2xl font-bold text-lg text-slate-700 shadow-sm mb-3 text-left hover:border-brand-500 hover:bg-brand-50 hover:text-brand-700 transition-all active:scale-[0.98]">
                        ${opt}
                    </button>
                `).join('');
            } else {
                container.innerHTML = '<p class="text-center font-bold text-slate-500 mt-10">–û—Ç–≥–æ–≤–æ—Ä–∏ –Ω–∞ –µ–∫—Ä–∞–Ω–∞ –Ω–∞ —É—á–∏—Ç–µ–ª—è.</p>';
            }
        }

        window.submitLiveAnswer = async (val) => {
            if (lastAnsweredIdx === liveActiveQIdx) return; // –≤–µ—á–µ –æ—Ç–≥–æ–≤–æ—Ä–µ–Ω–æ
            lastAnsweredIdx = liveActiveQIdx;

            const isCorrect = (liveCurrentQ.type === 'boolean' || liveCurrentQ.type === 'single') ? (val === liveCurrentQ.correct) : true;
            if (isCorrect) liveScore += (liveCurrentQ.points || 1);

            document.getElementById('client-question').classList.add('hidden');
            document.getElementById('client-waiting').classList.remove('hidden');
            document.getElementById('waiting-status-text').innerText = isCorrect ? '‚úÖ –í–ï–†–ï–ù –û–¢–ì–û–í–û–†!' : '‚ùå –ì–†–ï–®–ï–ù –û–¢–ì–û–í–û–†...';

            const updateData = { score: liveScore };
            updateData[`answers.${liveActiveQIdx}`] = isCorrect;

            try {
                await updateDoc(getParticipantRef(sessionID, auth.currentUser.uid), updateData);
            } catch (e) {
                console.warn('–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∑–∞–ø–∏—Å –Ω–∞ –æ—Ç–≥–æ–≤–æ—Ä:', e);
            }
        };

        // ========== –î–†–£–ì–ò –ü–û–ú–û–©–ù–ò ==========
        window.requestStorageAccess = async () => {
            try {
                await document.requestStorageAccess();
                window.showMessage('–î–æ—Å—Ç—ä–ø—ä—Ç –µ —Ä–∞–∑—Ä–µ—à–µ–Ω. –ü—Ä–µ–∑–∞—Ä–µ–¥–µ—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ç–∞.', 'success');
                setTimeout(() => location.reload(), 2000);
            } catch (e) {
                window.showMessage('–ù–µ—É—Å–ø–µ—Ö. –ü—Ä–æ–≤–µ—Ä–µ—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏—Ç–µ –Ω–∞ –±—Ä–∞—É–∑—ä—Ä–∞.', 'error');
            }
        };

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ
        window.addEventListener('DOMContentLoaded', () => {
            const params = new URLSearchParams(window.location.search);
            const pin = params.get('pin');
            if (pin) {
                setTimeout(() => {
                    const pinInput = document.getElementById('live-pin');
                    if (pinInput) pinInput.value = pin;
                }, 1000);
            }

            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ —Å–∫—Ä–∏–≤–∞–Ω–µ –Ω–∞ loader —Å–ª–µ–¥ 3 —Å–µ–∫—É–Ω–¥–∏ (–∞–∫–æ –Ω–µ –µ —Å–∫—Ä–∏—Ç)
            setTimeout(() => {
                const loader = document.getElementById('auth-loader');
                if (loader && !loader.classList.contains('hidden')) loader.classList.add('hidden');
            }, 3000);
        });

        window.onYouTubeIframeAPIReady = () => { console.log('YouTube API –≥–æ—Ç–æ–≤.'); };

        // –ï–∫—Å–ø–æ—Ä—Ç –Ω–∞ —Ñ—É–Ω–∫—Ü–∏–∏ –≤ window (–∑–∞ –¥–∞ —Ä–∞–±–æ—Ç—è—Ç onclick handlers)
        // (–≤–µ—á–µ —Å–∞ –¥–µ–∫–ª–∞—Ä–∏—Ä–∞–Ω–∏ –∫–∞—Ç–æ window.xxx)
    </script>
</body>
</html>
